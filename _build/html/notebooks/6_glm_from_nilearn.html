
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6. First level GLM &#8212; Pydra Tutorial</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="&lt;no title&gt;" href="5_intro_shelltask.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Pydra Tutorial</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1_intro_pydra.html">
   1. Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2_intro_functiontask.html">
   2. FunctionTask
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3_intro_functiontask_state.html">
   3. Tasks with States
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   6. First level GLM
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/notebooks/6_glm_from_nilearn.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/6_glm_from_nilearn.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Yibeichan/pydra-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Yibeichan/pydra-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/6_glm_from_nilearn.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Yibeichan/pydra-book/master?urlpath=tree/docs/notebooks/6_glm_from_nilearn.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparation">
   Preparation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-tasks">
   Create tasks
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetch-openneuro-bids-dataset">
     fetch openneuro BIDS dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#obtain-firstlevelmodel-objects-automatically-and-fit-arguments">
     obtain FirstLevelModel objects automatically and fit arguments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-design-matrix">
     Get design matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-1st-level-model">
     Fit 1st level model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-cluster-table-and-glm-report">
     Get cluster table and glm report
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-plots">
     Make plots
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-a-workflow-from-tasks">
   Make a workflow from tasks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-overaching-workflow">
   The overaching workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-workflow-run">
   Run Workflow Run
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualization">
   Visualization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examine-folder-structure">
   Examine folder structure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-figures">
     Plot figures
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#first-level-contrast">
       First level contrast
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nilearn-z-map">
       Nilearn Z map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fsl-z-map">
       FSL Z map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nilearn-fsl-comparison">
       Nilearn FSL comparison
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>6. First level GLM</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparation">
   Preparation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-tasks">
   Create tasks
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetch-openneuro-bids-dataset">
     fetch openneuro BIDS dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#obtain-firstlevelmodel-objects-automatically-and-fit-arguments">
     obtain FirstLevelModel objects automatically and fit arguments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-design-matrix">
     Get design matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-1st-level-model">
     Fit 1st level model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-cluster-table-and-glm-report">
     Get cluster table and glm report
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-plots">
     Make plots
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-a-workflow-from-tasks">
   Make a workflow from tasks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-overaching-workflow">
   The overaching workflow
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-workflow-run">
   Run Workflow Run
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualization">
   Visualization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examine-folder-structure">
   Examine folder structure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-figures">
     Plot figures
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#first-level-contrast">
       First level contrast
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nilearn-z-map">
       Nilearn Z map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fsl-z-map">
       FSL Z map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nilearn-fsl-comparison">
       Nilearn FSL comparison
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="first-level-glm">
<h1>6. First level GLM<a class="headerlink" href="#first-level-glm" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, we will go through a simple workflow of the first level general linear modeling with a BIDS dataset from openneuro. This analysis is only performed on <strong>one</strong> subject.</p>
<p>This tutorial is based on the <a class="reference external" href="https://nilearn.github.io/stable/auto_examples/04_glm_first_level/plot_bids_features.html#sphx-glr-auto-examples-04-glm-first-level-plot-bids-features-py">Nilearn GLM tutorial</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nest_asyncio</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Import packages that will be used globally and set up output directory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pydra</span>
<span class="kn">from</span> <span class="nn">pydra</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">pydra.engine.specs</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">ty</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># get current directory</span>
<span class="n">pydra_tutorial_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

<span class="c1"># set up output directory</span>
<span class="n">workflow_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pydra_tutorial_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;outputs&quot;</span> 
<span class="n">workflow_out_dir</span> <span class="o">=</span> <span class="n">workflow_dir</span> <span class="o">/</span> <span class="s2">&quot;6_glm&quot;</span>

<span class="c1"># create the output directory if not exit</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-tasks">
<h2>Create tasks<a class="headerlink" href="#create-tasks" title="Permalink to this headline">¶</a></h2>
<p>In this section, we converte major steps into tasks.
Each pydra task can have multiple python functions. We recommand to put those logically more related functions into the same task.</p>
<p>It is very <strong>important</strong> to keep in mind what adjacent tasks of your current task will be.</p>
<ol class="simple">
<li><p>Your previous task will decide your arguments in the current task</p></li>
<li><p>Your next task will be impacted by the returns in the current task</p></li>
</ol>
<div class="section" id="fetch-openneuro-bids-dataset">
<h3>fetch openneuro BIDS dataset<a class="headerlink" href="#fetch-openneuro-bids-dataset" title="Permalink to this headline">¶</a></h3>
<p>In this task, we do the following:</p>
<ol class="simple">
<li><p>get openneuro dataset index</p></li>
<li><p>specify exclusion patterns and number of subjects</p></li>
<li><p>download the data we need</p></li>
</ol>
<p><strong>Notes:</strong> Here we still use <code class="docutils literal notranslate"><span class="pre">n_subjects</span></code> as an argument. Given that we will only analyze one subject, you can also remove this argument and specify <code class="docutils literal notranslate"><span class="pre">n_subjects</span> <span class="pre">=1</span></code> in <code class="docutils literal notranslate"><span class="pre">select_from_index</span></code>. If you do, do not forget to modify the argument in the workflow later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;exclusion_patterns&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;n_subjects&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;data_dir&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">get_openneuro_dataset</span><span class="p">(</span><span class="n">exclusion_patterns</span><span class="p">,</span> <span class="n">n_subjects</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">nilearn.datasets</span> <span class="kn">import</span> <span class="p">(</span><span class="n">fetch_openneuro_dataset_index</span><span class="p">,</span>
                              <span class="n">fetch_openneuro_dataset</span><span class="p">,</span> <span class="n">select_from_index</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">fetch_openneuro_dataset_index</span><span class="p">()</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="n">select_from_index</span><span class="p">(</span>
        <span class="n">urls</span><span class="p">,</span> <span class="n">exclusion_filters</span><span class="o">=</span><span class="n">exclusion_patterns</span><span class="p">,</span> <span class="n">n_subjects</span> <span class="o">=</span> <span class="n">n_subjects</span><span class="p">)</span>
    <span class="n">data_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fetch_openneuro_dataset</span><span class="p">(</span><span class="n">urls</span><span class="o">=</span><span class="n">urls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_dir</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="obtain-firstlevelmodel-objects-automatically-and-fit-arguments">
<h3>obtain FirstLevelModel objects automatically and fit arguments<a class="headerlink" href="#obtain-firstlevelmodel-objects-automatically-and-fit-arguments" title="Permalink to this headline">¶</a></h3>
<p>To get the first level model(s) we have to specify</p>
<ol class="simple">
<li><p>the dataset directory</p></li>
<li><p>the task_label</p></li>
<li><p>the space_label</p></li>
<li><p>the folder with the desired derivatives (fMRIPrep)</p></li>
</ol>
<p>In our case, we only have one subject so we will only have one first level model.
Then, for this model, we will obtain</p>
<ol class="simple">
<li><p>the list of run images</p></li>
<li><p>events</p></li>
<li><p>confound regressors</p></li>
</ol>
<p>Those are inferred from the confounds.tsv files available in the BIDS dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;data_dir&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;task_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;space_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span><span class="s2">&quot;derivatives_folder&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;smoothing_fwhm&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                      <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;imgs&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">get_info_from_bids</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">,</span>
    <span class="n">task_label</span><span class="p">,</span>
    <span class="n">space_label</span><span class="p">,</span>
    <span class="n">smoothing_fwhm</span><span class="p">,</span>
    <span class="n">derivatives_folder</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">first_level_from_bids</span>
    <span class="n">models</span><span class="p">,</span> <span class="n">models_run_imgs</span><span class="p">,</span> <span class="n">models_events</span><span class="p">,</span> <span class="n">models_confounds</span> <span class="o">=</span> \
    <span class="n">first_level_from_bids</span><span class="p">(</span><span class="n">dataset_path</span> <span class="o">=</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">task_label</span> <span class="o">=</span> <span class="n">task_label</span><span class="p">,</span> <span class="n">space_label</span> <span class="o">=</span> <span class="n">space_label</span><span class="p">,</span>
                          <span class="n">smoothing_fwhm</span> <span class="o">=</span> <span class="n">smoothing_fwhm</span><span class="p">,</span> <span class="n">derivatives_folder</span> <span class="o">=</span> <span class="n">derivatives_folder</span><span class="p">)</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">confounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">models_run_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">models_events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">models_confounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;sub-&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">subject_label</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">subject</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="get-design-matrix">
<h3>Get design matrix<a class="headerlink" href="#get-design-matrix" title="Permalink to this headline">¶</a></h3>
<p>This task does the following:</p>
<ol class="simple">
<li><p>read the design matrix in <code class="docutils literal notranslate"><span class="pre">.mat</span></code></p></li>
<li><p>rename the column</p></li>
<li><p>save the new design matrix as <code class="docutils literal notranslate"><span class="pre">.csv</span></code></p></li>
</ol>
<p><strong>Think:</strong> What if we don’t save the new design matrix, but <code class="docutils literal notranslate"><span class="pre">return</span></code> it directly? In other words, we <code class="docutils literal notranslate"><span class="pre">return</span></code> a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">path</span></code>. What will happen? Worth a try :)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;data_dir&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;subject&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dm_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">get_designmatrix</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">nilearn.interfaces.fsl</span> <span class="kn">import</span> <span class="n">get_design_from_fslmat</span>
    <span class="n">fsl_design_matrix_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;stopsignal.feat&#39;</span><span class="p">,</span> <span class="s1">&#39;design.mat&#39;</span><span class="p">)</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">get_design_from_fslmat</span><span class="p">(</span><span class="n">fsl_design_matrix_path</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="n">design_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cond_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">))]</span>
    <span class="n">design_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Go&#39;</span>
    <span class="n">design_columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;StopSuccess&#39;</span>
    <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">design_columns</span>
    <span class="n">dm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;designmatrix.csv&quot;</span><span class="p">)</span>
    <span class="n">design_matrix</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dm_path</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dm_path</span>                      
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fit-1st-level-model">
<h3>Fit 1st level model<a class="headerlink" href="#fit-1st-level-model" title="Permalink to this headline">¶</a></h3>
<p>What we are doing here is:</p>
<ol class="simple">
<li><p>use the design matrix to fit the first level model</p></li>
<li><p>compute the contrast</p></li>
<li><p>save the z_map and masker for futher use</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span><span class="s2">&quot;imgs&quot;</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
                      <span class="s2">&quot;dm_path&quot;</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span><span class="s2">&quot;contrast&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;z_map_path&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;masker&quot;</span><span class="p">:</span><span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">model_fit</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> 
    <span class="n">imgs</span><span class="p">,</span>
    <span class="n">dm_path</span><span class="p">,</span>
    <span class="n">contrast</span>
<span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dm_path</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">design_matrices</span> <span class="o">=</span> <span class="p">[</span><span class="n">design_matrix</span><span class="p">])</span>
    <span class="n">z_map</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span>
    <span class="n">z_map_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;firstlevel_z_map.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">z_map</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_map_path</span><span class="p">)</span>
    <span class="n">masker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;firstlevel_masker.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">masker</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">masker_</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">z_map_path</span><span class="p">,</span> <span class="n">masker</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="get-cluster-table-and-glm-report">
<h3>Get cluster table and glm report<a class="headerlink" href="#get-cluster-table-and-glm-report" title="Permalink to this headline">¶</a></h3>
<p>For publication purposes, we obtain a cluster table and a summary report.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;z_map_path&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                    <span class="s2">&quot;return&quot;</span><span class="p">:{</span><span class="s2">&quot;output_file&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">cluster_table</span><span class="p">(</span><span class="n">z_map_path</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
    <span class="kn">from</span> <span class="nn">nilearn.reporting</span> <span class="kn">import</span> <span class="n">get_clusters_table</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
    
    <span class="n">stat_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">z_map_path</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;cluster_table.csv&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">get_clusters_table</span><span class="p">(</span><span class="n">stat_img</span><span class="p">,</span>
                            <span class="n">stat_threshold</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> 
                            <span class="n">cluster_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span>

<span class="c1"># get glm report</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;contrasts&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                    <span class="s2">&quot;return&quot;</span><span class="p">:{</span><span class="s2">&quot;output_file&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">glm_report</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">contrasts</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">nilearn.reporting</span> <span class="kn">import</span> <span class="n">make_glm_report</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;glm_report.html&quot;</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">make_glm_report</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">contrasts</span><span class="p">)</span>
    <span class="n">report</span><span class="o">.</span><span class="n">save_as_html</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="make-plots">
<h3>Make plots<a class="headerlink" href="#make-plots" title="Permalink to this headline">¶</a></h3>
<p>Here we want to make some plots to display our results and compare the result from FSL.</p>
<ol class="simple">
<li><p>plot nilearn z-map</p></li>
<li><p>plot fsl z-map</p></li>
<li><p>plot nilearn and fsl comparison</p></li>
<li><p>plot design matrix contrast</p></li>
</ol>
<p>You can also seperate this task into multiple sub-tasks. But it makes more sense to put them into one task as they use the same files and function <code class="docutils literal notranslate"><span class="pre">nilearn.plotting</span></code> repeatedly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@pydra</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">annotate</span><span class="p">({</span><span class="s2">&quot;data_dir&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;dm_path&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;z_map_path&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
                      <span class="s2">&quot;contrast&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s2">&quot;subject&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;masker&quot;</span><span class="p">:</span><span class="n">ty</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> 
                      <span class="s2">&quot;return&quot;</span><span class="p">:{</span><span class="s2">&quot;output_file1&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;output_file2&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                <span class="s2">&quot;output_file3&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;output_file4&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">plots</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">,</span>
    <span class="n">dm_path</span><span class="p">,</span>
    <span class="n">z_map_path</span><span class="p">,</span>
    <span class="n">contrast</span><span class="p">,</span>
    <span class="n">subject</span><span class="p">,</span>
    <span class="n">masker</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
    <span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_glass_brain</span><span class="p">,</span> <span class="n">plot_img_comparison</span><span class="p">,</span> <span class="n">plot_contrast_matrix</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
    
    <span class="c1"># plot and save nilearn z-map</span>
    <span class="n">z_map</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">z_map_path</span><span class="p">)</span>
    <span class="n">output_file1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;nilearn_z_map.png&quot;</span><span class="p">)</span>
    <span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file1</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">threshold</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Nilearn Z map of &quot;StopSuccess - Go&quot; (unc p&lt;0.001)&#39;</span><span class="p">,</span>
                     <span class="n">plot_abs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">display_mode</span> <span class="o">=</span> <span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    
    <span class="c1"># plot and save fsl z-map</span>
    <span class="n">fsl_z_map</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;stopsignal.feat&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="s1">&#39;zstat12.nii.gz&#39;</span><span class="p">))</span>
    <span class="n">output_file2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;fsl_z_map.png&quot;</span><span class="p">)</span>
    <span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">fsl_z_map</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file2</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                     <span class="n">threshold</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;FSL Z map of &quot;StopSuccess - Go&quot; (unc p&lt;0.001)&#39;</span><span class="p">,</span>
                     <span class="n">plot_abs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">display_mode</span> <span class="o">=</span> <span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
    
    <span class="c1"># plot and save nilearn and fsl comparison</span>
    <span class="n">plot_img_comparison</span><span class="p">([</span><span class="n">z_map</span><span class="p">],</span> <span class="p">[</span><span class="n">fsl_z_map</span><span class="p">],</span> <span class="n">masker</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="n">workflow_out_dir</span><span class="p">,</span> 
                        <span class="n">ref_label</span> <span class="o">=</span> <span class="s1">&#39;Nilearn&#39;</span><span class="p">,</span> <span class="n">src_label</span> <span class="o">=</span> <span class="s1">&#39;FSL&#39;</span><span class="p">)</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;0000.png&quot;</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;nilearn_fsl_comp.png&quot;</span><span class="p">)</span>
    <span class="n">output_file3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">)</span>
    
    <span class="c1"># plot and save design matrix contrast</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dm_path</span><span class="p">)</span>
    <span class="n">output_file4</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workflow_out_dir</span><span class="p">,</span> <span class="s2">&quot;firstlevel_contrast.png&quot;</span><span class="p">)</span>
    <span class="n">plot_contrast_matrix</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">design_matrix</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file1</span><span class="p">,</span> <span class="n">output_file2</span><span class="p">,</span> <span class="n">output_file3</span><span class="p">,</span> <span class="n">output_file4</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="make-a-workflow-from-tasks">
<h2>Make a workflow from tasks<a class="headerlink" href="#make-a-workflow-from-tasks" title="Permalink to this headline">¶</a></h2>
<p>Now we have created all tasks we need for this first level analysis, and there are two choices for our next step.</p>
<ol class="simple">
<li><p>create one workflow to connect all tasks together</p></li>
<li><p>create sub-workflows with some closely related tasks, and connect these workflows along with other tasks into a larger workflow.</p></li>
</ol>
<p>We recommand the second approach as it is alway a good practice to group tasks, especially when there are a large number of tasks in the analysis.</p>
<p>Our analysis can be divided into three parts: (1) get/read the data, (2) analyze the data, and (3) plot the result, where (1) and (3) only have one task each. So we can put all tasks in (2) into one workflow and name it as <code class="docutils literal notranslate"><span class="pre">firstlevel</span></code> or whatever you prefer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initiate a workflow</span>
<span class="n">wf_firstlevel</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;wf_firstlevel&quot;</span><span class="p">,</span> <span class="n">input_spec</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;task_label&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;space_label&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;derivatives_folder&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;smoothing_fwhm&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;contrast&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
                     <span class="p">)</span>

<span class="c1"># specify input</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">task_label</span> <span class="o">=</span> <span class="s1">&#39;stopsignal&#39;</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">space_label</span> <span class="o">=</span> <span class="s1">&#39;MNI152NLin2009cAsym&#39;</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">derivatives_folder</span> <span class="o">=</span> <span class="s1">&#39;derivatives/fmriprep&#39;</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">smoothing_fwhm</span> <span class="o">=</span> <span class="mf">5.0</span>

<span class="c1"># add task - get_info_from_bids</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">get_info_from_bids</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;get_info_from_bids&quot;</span><span class="p">,</span>
                          <span class="n">data_dir</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                          <span class="n">task_label</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">task_label</span><span class="p">,</span>
                          <span class="n">space_label</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">space_label</span><span class="p">,</span>
                          <span class="n">derivatives_folder</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">derivatives_folder</span><span class="p">,</span>
                          <span class="n">smoothing_fwhm</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">smoothing_fwhm</span>
                         <span class="p">)</span>
      <span class="p">)</span>
<span class="c1"># add task - get_designmatrix</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">get_designmatrix</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;get_designmatrix&quot;</span><span class="p">,</span>
                        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                        <span class="n">subject</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_info_from_bids</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span>
                       <span class="p">)</span>
      <span class="p">)</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_fit</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;l1estimation&quot;</span><span class="p">,</span>
                   <span class="n">model</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_info_from_bids</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
                   <span class="n">imgs</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_info_from_bids</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">imgs</span><span class="p">,</span> 
                   <span class="n">dm_path</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_designmatrix</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">dm_path</span><span class="p">,</span>
                   <span class="n">contrast</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">contrast</span>
                <span class="p">)</span>
      <span class="p">)</span>
<span class="c1"># add task - cluster_table</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cluster_table</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;cluster_table&quot;</span><span class="p">,</span> 
                     <span class="n">z_map_path</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">l1estimation</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">z_map_path</span><span class="p">))</span>
<span class="c1"># add task - glm_report</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">glm_report</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;glm_report&quot;</span><span class="p">,</span>
                  <span class="n">model</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">l1estimation</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                  <span class="n">contrasts</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">contrast</span>
                 <span class="p">)</span>
      <span class="p">)</span>
<span class="c1"># specify output</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">set_output</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;z_map&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">l1estimation</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">z_map_path</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;masker&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">l1estimation</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">masker</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_info_from_bids</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">subject</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dm_path&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">get_designmatrix</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">dm_path</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;cluster_table&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">cluster_table</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;glm_report&quot;</span><span class="p">,</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">glm_report</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-overaching-workflow">
<h2>The overaching workflow<a class="headerlink" href="#the-overaching-workflow" title="Permalink to this headline">¶</a></h2>
<p>Connect other tasks and the above workflow into one</p>
<p>Now we need to create the overaching glm workflow that connects the above workflow and other tasks (e.g., <code class="docutils literal notranslate"><span class="pre">get/read</span> <span class="pre">the</span> <span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">plot</span> <span class="pre">the</span> <span class="pre">result</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;firstlevel_glm&quot;</span><span class="p">,</span>
              <span class="n">input_spec</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;exclusion_patterns&quot;</span><span class="p">,</span><span class="s2">&quot;n_subjects&quot;</span><span class="p">,</span><span class="s2">&quot;contrast&quot;</span><span class="p">,</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
             <span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">exclusion_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*group*&#39;</span><span class="p">,</span> <span class="s1">&#39;*phenotype*&#39;</span><span class="p">,</span> <span class="s1">&#39;*mriqc*&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;*parameter_plots*&#39;</span><span class="p">,</span> <span class="s1">&#39;*physio_plots*&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;*space-fsaverage*&#39;</span><span class="p">,</span> <span class="s1">&#39;*space-T1w*&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;*dwi*&#39;</span><span class="p">,</span> <span class="s1">&#39;*beh*&#39;</span><span class="p">,</span> <span class="s1">&#39;*task-bart*&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;*task-rest*&#39;</span><span class="p">,</span> <span class="s1">&#39;*task-scap*&#39;</span><span class="p">,</span> <span class="s1">&#39;*task-task*&#39;</span><span class="p">]</span>
<span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">n_subjects</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">workflow_out_dir</span>
<span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="s1">&#39;StopSuccess - Go&#39;</span>

<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">get_openneuro_dataset</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;get_openneuro_dataset&quot;</span><span class="p">,</span> 
                             <span class="n">exclusion_patterns</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">exclusion_patterns</span><span class="p">,</span>
                             <span class="n">n_subjects</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">n_subjects</span>
                            <span class="p">)</span>
      <span class="p">)</span>

<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">get_openneuro_dataset</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">data_dir</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrast</span>
<span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_dir</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wf_firstlevel</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">plots</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;plots&quot;</span><span class="p">,</span>
             <span class="n">data_dir</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">get_openneuro_dataset</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
             <span class="n">dm_path</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">dm_path</span><span class="p">,</span>
             <span class="n">z_map_path</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">z_map</span><span class="p">,</span>
             <span class="n">contrast</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">lzin</span><span class="o">.</span><span class="n">contrast</span><span class="p">,</span>
             <span class="n">subject</span> <span class="o">=</span>  <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span>
             <span class="n">masker</span> <span class="o">=</span> <span class="n">wf_firstlevel</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">masker</span>
            <span class="p">)</span>
      <span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">set_output</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;output1&quot;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file1</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;output2&quot;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file2</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;output3&quot;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file3</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;output4&quot;</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">lzout</span><span class="o">.</span><span class="n">output_file4</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-workflow-run">
<h2>Run Workflow Run<a class="headerlink" href="#run-workflow-run" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydra</span> <span class="kn">import</span> <span class="n">Submitter</span>

<span class="k">with</span> <span class="n">Submitter</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;cf&quot;</span><span class="p">,</span> <span class="n">n_procs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">submitter</span><span class="p">:</span>
    <span class="n">submitter</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/site-packages/nilearn/glm/__init__.py:56: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  &#39;It may change in any future release of Nilearn.&#39;, FutureWarning)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/site-packages/nilearn/glm/first_level/first_level.py:905: UserWarning: SliceTimingRef not found in file /Users/yibeichen/nilearn_data/ds000030/ds000030_R1.0.4/uncompressed/sub-10159/func/sub-10159_task-stopsignal_bold.json. It will be assumed that the slice timing reference is 0.0 percent of the repetition time. If it is not the case it will need to be set manually in the generated list of models
  img_specs[0])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/site-packages/nilearn/glm/__init__.py:56: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  &#39;It may change in any future release of Nilearn.&#39;, FutureWarning)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/site-packages/nilearn/glm/__init__.py:56: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  &#39;It may change in any future release of Nilearn.&#39;, FutureWarning)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Process ForkProcess-2:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Process ForkProcess-1:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Process ForkProcess-3:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 297, in _bootstrap
    self.run()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 297, in _bootstrap
    self.run()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 297, in _bootstrap
    self.run()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 99, in run
    self._target(*self._args, **self._kwargs)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 99, in run
    self._target(*self._args, **self._kwargs)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/process.py&quot;, line 99, in run
    self._target(*self._args, **self._kwargs)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/concurrent/futures/process.py&quot;, line 233, in _process_worker
    call_item = call_queue.get(block=True)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/concurrent/futures/process.py&quot;, line 233, in _process_worker
    call_item = call_queue.get(block=True)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/concurrent/futures/process.py&quot;, line 233, in _process_worker
    call_item = call_queue.get(block=True)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/queues.py&quot;, line 93, in get
    with self._rlock:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/queues.py&quot;, line 93, in get
    with self._rlock:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/queues.py&quot;, line 94, in get
    res = self._recv_bytes()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/synchronize.py&quot;, line 95, in __enter__
    return self._semlock.__enter__()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/connection.py&quot;, line 216, in recv_bytes
    buf = self._recv_bytes(maxlength)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/synchronize.py&quot;, line 95, in __enter__
    return self._semlock.__enter__()
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KeyboardInterrupt
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/connection.py&quot;, line 407, in _recv_bytes
    buf = self._recv(4)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KeyboardInterrupt
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  File &quot;/Users/yibeichen/miniconda3/envs/pydra/lib/python3.7/multiprocessing/connection.py&quot;, line 379, in _recv
    chunk = read(handle, remaining)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KeyboardInterrupt
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">wr</span><span class="o">/</span><span class="n">x5xt_yqs2cvc_gb3sf147lvc0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_61272</span><span class="o">/</span><span class="mf">1775606206.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">with</span> <span class="n">Submitter</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;cf&quot;</span><span class="p">,</span> <span class="n">n_procs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">submitter</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">4</span>     <span class="n">submitter</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="nn">~/GDrive/GitHub/pydra/pydra/engine/submitter.py</span> in <span class="ni">__call__</span><span class="nt">(self, runnable, cache_locations, rerun)</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span>         <span class="k">if</span> <span class="n">cache_locations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span>             <span class="n">runnable</span><span class="o">.</span><span class="n">cache_locations</span> <span class="o">=</span> <span class="n">cache_locations</span>
<span class="ne">---&gt; </span><span class="mi">41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_from_call</span><span class="p">(</span><span class="n">runnable</span><span class="p">,</span> <span class="n">rerun</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span>         <span class="k">return</span> <span class="n">runnable</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> 

<span class="nn">~/miniconda3/envs/pydra/lib/python3.7/site-packages/nest_asyncio.py</span> in <span class="ni">run_until_complete</span><span class="nt">(self, future)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span>                 <span class="n">f</span><span class="o">.</span><span class="n">_log_destroy_pending</span> <span class="o">=</span> <span class="kc">False</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span>             <span class="k">while</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<span class="ne">---&gt; </span><span class="mi">83</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_run_once</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopping</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>                     <span class="k">break</span>

<span class="nn">~/miniconda3/envs/pydra/lib/python3.7/site-packages/nest_asyncio.py</span> in <span class="ni">_run_once</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span>                 <span class="n">scheduled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_when</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">86400</span><span class="p">)</span> <span class="k">if</span> <span class="n">scheduled</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>             <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">106</span>         <span class="n">event_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_process_events</span><span class="p">(</span><span class="n">event_list</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span> 

<span class="nn">~/miniconda3/envs/pydra/lib/python3.7/selectors.py</span> in <span class="ni">select</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span>             <span class="n">ready</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">558</span>                 <span class="n">kev_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector</span><span class="o">.</span><span class="n">control</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_ev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">559</span>             <span class="k">except</span> <span class="ne">InterruptedError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">560</span>                 <span class="k">return</span> <span class="n">ready</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h2>
<p>If you arrive here without any errors, yay, you just made your first pydra workflow for a first-level GLM!</p>
</div>
<div class="section" id="examine-folder-structure">
<h2>Examine folder structure<a class="headerlink" href="#examine-folder-structure" title="Permalink to this headline">¶</a></h2>
<p>Let’s take a look at what you have got.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls ../outputs/6_glm
</pre></div>
</div>
</div>
</div>
<details>
<summary>Click to see what you should get</summary>
<ol class="simple">
<li><p>cluster_table.csv</p></li>
<li><p>firstlevel_z_map.nii.gz</p></li>
<li><p>nilearn_fsl_comp.png</p></li>
<li><p>designmatrix.csv</p></li>
<li><p>fsl_z_map.png</p></li>
<li><p>nilearn_z_map.png</p></li>
<li><p>firstlevel_contrast.png glm_report.html</p></li>
</ol>
</details><div class="section" id="plot-figures">
<h3>Plot figures<a class="headerlink" href="#plot-figures" title="Permalink to this headline">¶</a></h3>
<div class="section" id="first-level-contrast">
<h4>First level contrast<a class="headerlink" href="#first-level-contrast" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../outputs/6_glm/firstlevel_contrast.png&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nilearn-z-map">
<h4>Nilearn Z map<a class="headerlink" href="#nilearn-z-map" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../outputs/6_glm/nilearn_z_map.png&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fsl-z-map">
<h4>FSL Z map<a class="headerlink" href="#fsl-z-map" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../outputs/6_glm/fsl_z_map.png&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nilearn-fsl-comparison">
<h4>Nilearn FSL comparison<a class="headerlink" href="#nilearn-fsl-comparison" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../outputs/6_glm/nilearn_fsl_comp.png&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p>What if we need to run the first-level GLM on multiple subject? We will need the <code class="docutils literal notranslate"><span class="pre">splitter</span></code>.</p>
<p>So, where should we add <code class="docutils literal notranslate"><span class="pre">.split</span></code>?</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="5_intro_shelltask.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">&lt;no title&gt;</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By TODO<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>